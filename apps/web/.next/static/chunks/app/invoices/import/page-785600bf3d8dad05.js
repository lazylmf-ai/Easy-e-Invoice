(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[769],{883:function(e,s,t){Promise.resolve().then(t.bind(t,5337))},5337:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return u}});var a=t(7573),l=t(7653),i=t(1695),r=t(286),n=t(5118),c=t(7727),d=t(3743),o=t(4802),m=t(4329);let x={invoiceNumber:"Invoice Number *",issueDate:"Issue Date *",dueDate:"Due Date",currency:"Currency",exchangeRate:"Exchange Rate",buyerName:"Buyer Name",buyerTin:"Buyer TIN",itemDescription:"Item Description *",quantity:"Quantity *",unitPrice:"Unit Price *",discountAmount:"Discount Amount",sstRate:"SST Rate (%)",notes:"Notes"};function u(){let[e,s]=(0,l.useState)(null),[t,u]=(0,l.useState)(""),[h,p]=(0,l.useState)(null),[g,v]=(0,l.useState)({}),[j,N]=(0,l.useState)(!0),[b,f]=(0,l.useState)(!1),[y,w]=(0,l.useState)(""),[S,C]=(0,l.useState)(null),[I,k]=(0,l.useState)("upload"),[R,V]=(0,l.useState)(null),[P,F]=(0,l.useState)(null),D=(0,l.useRef)(null),{user:T}=(0,r.a)(),M=(0,i.useRouter)(),O=async e=>{f(!0),w("");try{let s=await n.hi.import.parseCSV(e);p(s),v(s.suggestedMappings),k("mapping")}catch(e){console.error("CSV parsing failed:",e),w(e.message||"Failed to parse CSV file")}finally{f(!1)}},E=(e,s)=>{let t=""===s?-1:parseInt(s);v(s=>({...s,[e]:t}))},z=async()=>{f(!0),w("");try{let e=await n.hi.import.importInvoices({csvData:t,columnMapping:g,hasHeaders:j,validateOnly:!0});C(e),k("preview")}catch(e){console.error("Import preview failed:",e),w(e.message||"Failed to preview import")}finally{f(!1)}},L=async()=>{f(!0),w("");try{let e=t.split("\n").filter(e=>e.trim());if((j?e.length-1:e.length)>50){let e=await n.hi.import.startChunkedImport({csvData:t,columnMapping:g,hasHeaders:j,validateOnly:!1,batchSize:100});V(e.importId),k("processing"),U(e.importId)}else{let e=await n.hi.import.importInvoices({csvData:t,columnMapping:g,hasHeaders:j,validateOnly:!1});C(e),k("complete")}}catch(e){console.error("Import failed:",e),w(e.message||"Failed to import invoices")}finally{f(!1)}},U=e=>{let s=setInterval(async()=>{try{let t=await n.hi.import.getProgress(e);F(t),("completed"===t.status||"failed"===t.status)&&(clearInterval(s),"completed"===t.status?(C({total:t.total,processed:t.processed,successful:t.successful,failed:t.failed,errors:t.errors,warnings:t.warnings,invoices:[],validateOnly:!1,timestamp:new Date().toISOString()}),k("complete")):w("Import failed during processing"))}catch(e){console.error("Failed to get progress:",e),clearInterval(s),w("Failed to track import progress")}},2e3);setTimeout(()=>{clearInterval(s)},18e5)},_=async()=>{try{let e=await fetch("".concat("http://localhost:8787","/import/template"),{headers:{Authorization:"Bearer ".concat(localStorage.getItem("auth_token"))}});if(!e.ok)throw Error("Failed to download template");let s=await e.blob(),t=window.URL.createObjectURL(s),a=document.createElement("a");a.href=t,a.download="invoice-import-template.csv",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(t),document.body.removeChild(a)}catch(e){w(e.message||"Failed to download template")}},A=()=>{s(null),u(""),p(null),v({}),C(null),V(null),F(null),k("upload"),w(""),D.current&&(D.current.value="")};return(null==T?void 0:T.hasCompletedOnboarding)?(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsxs)("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8",children:[(0,a.jsx)("div",{className:"mb-8",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-3xl font-bold text-gray-900",children:"Import Invoices"}),(0,a.jsx)("p",{className:"mt-2 text-gray-600",children:"Import invoices from CSV with Malaysian compliance validation"})]}),(0,a.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,a.jsxs)("button",{onClick:_,className:"btn-secondary flex items-center",children:[(0,a.jsx)(o.Z,{className:"h-5 w-5 mr-2"}),"Download Template"]}),(0,a.jsx)("button",{onClick:()=>M.push("/invoices"),className:"btn-secondary",children:"Cancel"})]})]})}),(0,a.jsx)("div",{className:"mb-8",children:(0,a.jsx)("nav",{"aria-label":"Progress",children:(0,a.jsx)("ol",{className:"flex items-center",children:[{id:"upload",name:"Upload CSV",status:"upload"===I?"current":["mapping","preview","processing","complete"].includes(I)?"complete":"upcoming"},{id:"mapping",name:"Map Columns",status:"mapping"===I?"current":["preview","processing","complete"].includes(I)?"complete":"upcoming"},{id:"preview",name:"Preview & Validate",status:"preview"===I?"current":["processing","complete"].includes(I)?"complete":"upcoming"},{id:"processing",name:"Processing",status:"processing"===I?"current":"complete"===I?"complete":"upcoming"},{id:"complete",name:"Import Complete",status:"complete"===I?"current":"upcoming"}].map((e,s)=>(0,a.jsx)("li",{className:4!==s?"pr-8 sm:pr-20":"",children:(0,a.jsxs)("div",{className:"relative",children:["complete"===e.status?(0,a.jsx)("div",{className:"absolute inset-0 flex items-center","aria-hidden":"true",children:(0,a.jsx)("div",{className:"h-0.5 w-full bg-primary-600"})}):(e.status,(0,a.jsx)("div",{className:"absolute inset-0 flex items-center","aria-hidden":"true",children:(0,a.jsx)("div",{className:"h-0.5 w-full bg-gray-200"})})),(0,a.jsx)("div",{className:"relative w-8 h-8 flex items-center justify-center rounded-full ".concat("complete"===e.status?"bg-primary-600":"current"===e.status?"bg-primary-600":"bg-white border-2 border-gray-300"),children:"complete"===e.status?(0,a.jsx)(d.Z,{className:"w-5 h-5 text-white"}):(0,a.jsx)("span",{className:"text-sm font-medium ".concat("current"===e.status?"text-white":"text-gray-500"),children:s+1})}),(0,a.jsx)("div",{className:"mt-2",children:(0,a.jsx)("span",{className:"text-xs font-medium ".concat("current"===e.status?"text-primary-600":"text-gray-500"),children:e.name})})]})},e.id))})})}),y&&(0,a.jsx)("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-md p-4",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)(m.Z,{className:"h-5 w-5 text-red-400"})}),(0,a.jsxs)("div",{className:"ml-3",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Error"}),(0,a.jsx)("div",{className:"mt-2 text-sm text-red-700",children:(0,a.jsx)("p",{children:y})})]})]})}),(0,a.jsxs)("div",{className:"bg-white shadow-sm rounded-lg",children:["upload"===I&&(0,a.jsx)("div",{className:"p-6",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)(c.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,a.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Upload CSV File"}),(0,a.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Select a CSV file containing invoice data to import"}),(0,a.jsxs)("div",{className:"mt-6",children:[(0,a.jsx)("input",{ref:D,type:"file",accept:".csv",onChange:e=>{var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;if(!a.name.endsWith(".csv")){w("Please select a CSV file (.csv extension required)");return}if(a.size>10485760){w("File size too large. Please select a CSV file smaller than 10MB.");return}let l=Math.ceil(a.size/100);if(l>1e4&&!window.confirm("This file appears to contain approximately ".concat(l.toLocaleString()," rows. ")+"Large files may take several minutes to process. Do you want to continue?"))return;s(a),w("");let i=new FileReader;i.onload=e=>{var s;let t=null===(s=e.target)||void 0===s?void 0:s.result;if(!t.trim()){w("CSV file appears to be empty");return}if(t.split("\n").filter(e=>e.trim()).length<2){w("CSV file must contain at least a header row and one data row");return}u(t),O(t)},i.readAsText(a)},className:"hidden"}),(0,a.jsx)("button",{onClick:()=>{var e;return null===(e=D.current)||void 0===e?void 0:e.click()},className:"btn-primary",disabled:b,children:b?"Parsing...":"Select CSV File"})]}),e&&(0,a.jsxs)("div",{className:"mt-4 text-sm text-gray-600",children:["Selected: ",e.name," (",(e.size/1024).toFixed(1)," KB)"]})]})}),"mapping"===I&&h&&(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Map CSV Columns"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"Map your CSV columns to invoice fields. Required fields are marked with *."}),(0,a.jsx)("div",{className:"mb-4",children:(0,a.jsxs)("label",{className:"flex items-center",children:[(0,a.jsx)("input",{type:"checkbox",checked:j,onChange:e=>N(e.target.checked),className:"rounded border-gray-300 text-primary-600 focus:ring-primary-500"}),(0,a.jsx)("span",{className:"ml-2 text-sm text-gray-700",children:"First row contains headers"})]})}),(0,a.jsx)("div",{className:"grid grid-cols-1 gap-4 lg:grid-cols-2",children:Object.entries(x).map(e=>{var s;let[t,l]=e;return(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:l}),(0,a.jsxs)("select",{value:null!==(s=g[t])&&void 0!==s?s:"",onChange:e=>E(t,e.target.value),className:"input w-full",children:[(0,a.jsx)("option",{value:"",children:"-- Select Column --"}),h.headers.map((e,s)=>(0,a.jsxs)("option",{value:s,children:["Column ",s+1,": ",e]},s))]})]},t)})}),h.dataRows.length>0&&(0,a.jsxs)("div",{className:"mt-6",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:"Data Preview"}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"min-w-full border border-gray-200",children:[(0,a.jsx)("thead",{className:"bg-gray-50",children:(0,a.jsx)("tr",{children:h.headers.map((e,s)=>(0,a.jsxs)("th",{className:"px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase",children:["Column ",s+1,": ",e]},s))})}),(0,a.jsx)("tbody",{children:h.dataRows.slice(0,3).map((e,s)=>(0,a.jsx)("tr",{className:"border-t border-gray-200",children:e.map((e,s)=>(0,a.jsx)("td",{className:"px-4 py-2 text-sm text-gray-900",children:e},s))},s))})]})}),(0,a.jsxs)("p",{className:"mt-2 text-xs text-gray-500",children:["Showing first 3 rows of ",h.totalRows," total rows"]})]}),(0,a.jsxs)("div",{className:"mt-6 flex justify-between",children:[(0,a.jsx)("button",{onClick:A,className:"btn-secondary",children:"Start Over"}),(0,a.jsx)("button",{onClick:z,disabled:b||!g.invoiceNumber||!g.issueDate||!g.itemDescription||!g.quantity||!g.unitPrice,className:"btn-primary",children:b?"Validating...":"Preview Import"})]})]}),"preview"===I&&S&&(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Import Preview"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-4 mb-6",children:[(0,a.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:S.total}),(0,a.jsx)("div",{className:"text-sm text-blue-600",children:"Total Rows"})]}),(0,a.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:S.successful}),(0,a.jsx)("div",{className:"text-sm text-green-600",children:"Valid Invoices"})]}),(0,a.jsxs)("div",{className:"bg-red-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:S.failed}),(0,a.jsx)("div",{className:"text-sm text-red-600",children:"Failed Rows"})]}),(0,a.jsxs)("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-yellow-600",children:S.warnings.length}),(0,a.jsx)("div",{className:"text-sm text-yellow-600",children:"Warnings"})]})]}),S.errors.length>0&&(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-red-800 mb-2",children:"Errors"}),(0,a.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-md p-3 max-h-48 overflow-y-auto",children:S.errors.map((e,s)=>(0,a.jsxs)("div",{className:"text-sm text-red-700 mb-1",children:["Row ",e.row,": ",e.message]},s))})]}),S.warnings.length>0&&(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsxs)("h4",{className:"text-sm font-medium text-yellow-800 mb-2",children:["Warnings (",S.warnings.length,")"]}),(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-3 max-h-48 overflow-y-auto",children:S.warnings.map((e,s)=>(0,a.jsxs)("div",{className:"text-sm text-yellow-700 mb-1 border-b border-yellow-200 pb-1",children:[(0,a.jsxs)("div",{className:"font-medium",children:["Row ",e.row]}),(0,a.jsx)("div",{children:e.message}),(0,a.jsxs)("div",{className:"text-xs text-yellow-600",children:["Validation Score: ",e.validationScore,"/100"]})]},s))})]}),S.successful>0&&(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-gray-800 mb-2",children:"Preview of Valid Data"}),(0,a.jsxs)("div",{className:"bg-gray-50 border border-gray-200 rounded-md p-3",children:[(0,a.jsx)("div",{className:"text-xs text-gray-600 mb-2",children:"Showing sample of validated invoice data that will be imported:"}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-2 sm:grid-cols-2",children:[(0,a.jsxs)("div",{className:"text-xs",children:[(0,a.jsx)("span",{className:"font-medium",children:"Invoice Format:"})," Malaysian e-Invoice compliant"]}),(0,a.jsxs)("div",{className:"text-xs",children:[(0,a.jsx)("span",{className:"font-medium",children:"SST Calculation:"})," Automatic 6% where applicable"]}),(0,a.jsxs)("div",{className:"text-xs",children:[(0,a.jsx)("span",{className:"font-medium",children:"Currency Support:"})," MYR with proper exchange rates"]}),(0,a.jsxs)("div",{className:"text-xs",children:[(0,a.jsx)("span",{className:"font-medium",children:"Validation Level:"})," LHDN compliance checked"]})]})]})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsx)("button",{onClick:()=>k("mapping"),className:"btn-secondary",children:"Back to Mapping"}),(0,a.jsxs)("div",{className:"space-x-4",children:[(0,a.jsx)("button",{onClick:A,className:"btn-secondary",children:"Cancel"}),(0,a.jsx)("button",{onClick:()=>{window.confirm("Are you sure you want to import ".concat(S.successful," invoices?\n\n")+"This will create ".concat(S.successful," new invoice records in your system. ")+"".concat(S.failed>0?"".concat(S.failed," rows with errors will be skipped. "):"")+"".concat(S.warnings.length>0?"".concat(S.warnings.length," invoices have validation warnings but will still be imported. "):"")+"\nThis action cannot be undone.")&&L()},disabled:b||0===S.successful,className:"btn-primary",children:b?"Importing...":"Import ".concat(S.successful," Invoices")})]})]})]}),"processing"===I&&P&&(0,a.jsxs)("div",{className:"p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Processing Import"}),(0,a.jsx)("p",{className:"text-sm text-gray-600 mb-6",children:"Please wait while we process your CSV file. This may take a few minutes for large files."}),(0,a.jsxs)("div",{className:"mb-6",children:[(0,a.jsxs)("div",{className:"flex justify-between text-sm text-gray-600 mb-2",children:[(0,a.jsxs)("span",{children:["Progress: ",P.processed," / ",P.total]}),(0,a.jsxs)("span",{children:[Math.round(P.processed/P.total*100),"%"]})]}),(0,a.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,a.jsx)("div",{className:"bg-primary-600 h-2 rounded-full transition-all duration-300",style:{width:"".concat(P.processed/P.total*100,"%")}})})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-4 sm:grid-cols-3 mb-6",children:[(0,a.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:P.successful}),(0,a.jsx)("div",{className:"text-sm text-green-600",children:"Successful"})]}),(0,a.jsxs)("div",{className:"bg-red-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:P.failed}),(0,a.jsx)("div",{className:"text-sm text-red-600",children:"Failed"})]}),(0,a.jsxs)("div",{className:"bg-blue-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:P.total-P.processed}),(0,a.jsx)("div",{className:"text-sm text-blue-600",children:"Remaining"})]})]}),P.elapsedTime&&(0,a.jsxs)("div",{className:"text-sm text-gray-600 mb-4",children:[(0,a.jsxs)("div",{children:["Elapsed: ",Math.floor(P.elapsedTime/1e3),"s"]}),P.estimatedTimeRemaining&&(0,a.jsxs)("div",{children:["Estimated remaining: ",Math.floor(P.estimatedTimeRemaining/1e3),"s"]})]}),(0,a.jsx)("div",{className:"flex justify-center",children:(0,a.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"})})]}),"complete"===I&&S&&(0,a.jsxs)("div",{className:"p-6 text-center",children:[(0,a.jsx)(d.Z,{className:"mx-auto h-12 w-12 text-green-500"}),(0,a.jsx)("h3",{className:"mt-2 text-lg font-medium text-gray-900",children:"Import Complete!"}),(0,a.jsxs)("p",{className:"mt-1 text-sm text-gray-500",children:["Successfully imported ",S.successful," out of ",S.total," invoices"]}),(0,a.jsxs)("div",{className:"mt-6 grid grid-cols-1 gap-4 sm:grid-cols-3",children:[(0,a.jsxs)("div",{className:"bg-green-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-green-600",children:S.successful}),(0,a.jsx)("div",{className:"text-sm text-green-600",children:"Successfully Imported"})]}),(0,a.jsxs)("div",{className:"bg-red-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-red-600",children:S.failed}),(0,a.jsx)("div",{className:"text-sm text-red-600",children:"Failed"})]}),(0,a.jsxs)("div",{className:"bg-yellow-50 p-4 rounded-lg",children:[(0,a.jsx)("div",{className:"text-2xl font-bold text-yellow-600",children:S.warnings.length}),(0,a.jsx)("div",{className:"text-sm text-yellow-600",children:"With Warnings"})]})]}),(0,a.jsxs)("div",{className:"mt-8 flex justify-center space-x-4",children:[(0,a.jsx)("button",{onClick:()=>M.push("/invoices"),className:"btn-primary",children:"View Invoices"}),(0,a.jsx)("button",{onClick:A,className:"btn-secondary",children:"Import More"})]})]})]})]})}):(0,a.jsx)("div",{className:"min-h-screen bg-gray-50 py-8",children:(0,a.jsx)("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:(0,a.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-md p-4",children:(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"flex-shrink-0",children:(0,a.jsx)(m.Z,{className:"h-5 w-5 text-yellow-400"})}),(0,a.jsxs)("div",{className:"ml-3",children:[(0,a.jsx)("h3",{className:"text-sm font-medium text-yellow-800",children:"Organization Setup Required"}),(0,a.jsx)("div",{className:"mt-2 text-sm text-yellow-700",children:(0,a.jsx)("p",{children:"Complete your organization setup before importing invoices."})}),(0,a.jsx)("div",{className:"mt-4",children:(0,a.jsx)("button",{onClick:()=>M.push("/org/setup"),className:"bg-yellow-50 px-2 py-1.5 rounded-md text-sm font-medium text-yellow-800 hover:bg-yellow-100",children:"Complete Setup"})})]})]})})})})}}},function(e){e.O(0,[522,216,592,744],function(){return e(e.s=883)}),_N_E=e.O()}]);